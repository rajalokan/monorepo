name: Server

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4    

      - name: Setup common env variables
        env:
          VARS_JSON: ${{ toJSON(vars) }}
        run: |
          echo "Printing all vars"
          echo ${VARS_JSON}
          SERVICE_ENV_JSON=$(echo ${VARS_JSON} | jq 'with_entries(select(.key | startswith("AWS_")))')
          echo "Printing filtered json"
          echo ${SERVICE_ENV_JSON}      
          SERVICE_ENV_STR=$(echo ${SERVICE_ENV_JSON} | jq -c | jq -R)
          echo "Printing filtered string"
          echo ${SERVICE_ENV_STR}      
          echo "SERVICE=${SERVICE_ENV_STR}" >> $GITHUB_ENV
        shell: bash

      - name: Echo
        run: |
          echo env_vars.AWS_ACCOUNT_ID
          echo env_vars.AWS_ROLE_NAME
        env:
          env_vars: ${{ env.SERVICE }}

      # # - name: Set up common environment variables
      # #   uses: ./.github/actions/setup-env
      
      # - name: Dump vars context
      #   env:
      #     VARS_JSON: ${{ toJSON(env) }}
      #   run: |
      #     echo "${VARS_JSON}"    

      # - name: Configure AWS credentials
      #   run: echo "Assuming role ${{ vars.AWS_ACCOUNT_ID }}:role/${{ vars.AWS_ROLE_NAME }} in ${{ vars.AWS_REGION }}"

      # - name: Login to Amazon ECR
      #   run: echo "Login to AWS ECR"

      # - name: Build, tag, and push sidecar image to ECR
      #   env:
      #     REGISTRY: rajalokan
      #     REPOSITORY: ${{ vars.APP_NAME }}-nginx-${{ inputs.environment }}
      #   run: |
      #     echo "docker build -t $REGISTRY/$REPOSITORY:latest nginx/"
      #     echo "docker push $REGISTRY/$REPOSITORY:latest"
          
      # - name: Build, tag, and push app image to ECR
      #   env:
      #     REGISTRY: rajalokan
      #     REPOSITORY: ${{ vars.APP_NAME }}-web-app-${{ inputs.environment }}
      #   run: |
      #     echo "docker build -t $REGISTRY/$REPOSITORY:latest nginx/"
      #     echo "docker push $REGISTRY/$REPOSITORY:latest"          
      
      # - name: Update ECS Task Definition
      #   run: |
      #     echo "aws ecs describe-task-definition \
      #       --task-definition ${{ vars.APP_NAME }}-${{ inputs.environment }} \
      #       --region ${{ vars.AWS_REGION }}"
      
      # - name: Update ECS Service
      #   run: |
      #     echo "aws ecs update-service \
      #       --cluster ${{ vars.APP_NAME }}-${{ env.CLUSTER_ENV }}${{ vars.CLUSTER_SUFFIX }} \
      #       --service ${{ vars.APP_NAME }}-${{ inputs.environment }} \
      #       --task-definition ${{ vars.APP_NAME }}-${{ inputs.environment }}:${{ env.TASK_REVISION }} \
      #       --desired-count 4"          
